---
title: "Heteroskedastic Mixtures"
output: html_notebook
---
```{r, message = FALSE}
library(tidyverse)
library(caret)
library(scico)
library(generative)
review_theme()
set.seed(0318022)
```

* Simulate data from a heteroskedastic mixture of t's
* Fit a standard GMM (stan)
* Fit a discriminator (caret)
* Visualize discriminator probabilities
* Fit updated heteroskedastic model
* Repeat discrimination
* Fit true model
* Repeat discrimination

```{r}
x <- t_mixture(250)
ggplot(x) +
  geom_point(aes(V1, V2, col = k)) +
  scale_color_brewer(palette = "Set2") +
  coord_fixed()
```

```{r}
fit <- fit_gmm(x, K = 5)
x_sim <- mixture_predictive(fit)
ggplot(x_sim) +
  geom_point(aes(`1`, `2`), size = 0.5, alpha = 0.8) +
  facet_wrap(~ .iteration) +
  coord_fixed()
```

```{r}
disc_data <- bind_dicriminative(x, x_sim)
ggplot(disc_data) +
  geom_point(aes(V1, V2, col = y), alpha = 1, size = 0.9) +
  scale_color_scico_d(palette = "berlin") +
  coord_fixed()
```

```{r, message = FALSE}
gbmGrid <-  expand.grid(
  interaction.depth = 5,
  n.trees = 100,
  shrinkage = 0.1,
  n.minobsinnode = 2
)

fit <- train(
  x = disc_data %>% select(-y), 
  y = disc_data$y, 
  method = "gbm",
  tuneGrid = gbmGrid
)
```

```{r}
table(disc_data$y, predict(fit))
```

```{r}
data.frame(prob = predict(fit, disc_data, type = "prob")) %>%
  bind_cols(disc_data) %>%
  ggplot() +
  geom_point(aes(V1, V2, col = prob.true)) +
  scale_color_scico(palette = "berlin") +
  facet_wrap(~ y) +
  coord_fixed()
```

```{r}
fit <- fit_tmm(x, K = 5)
x_sim <- mixture_predictive(fit)
ggplot(x_sim) +
  geom_point(aes(`1`, `2`), size = 0.5, alpha = 0.8) +
  facet_wrap(~ .iteration) +
  coord_fixed()
```

```{r}
disc_data <- bind_dicriminative(x, x_sim)
ggplot(disc_data) +
  geom_point(aes(V1, V2, col = y), alpha = 1, size = 0.9) +
  scale_color_scico_d(palette = "berlin") +
  coord_fixed()
```

```{r, message = FALSE}
disc_data <- bind_dicriminative(x, x_sim)
fit <- train(
  x = disc_data %>% select(-y), 
  y = disc_data$y, 
  method = "gbm",
  tuneGrid = gbmGrid
)
table(disc_data$y, predict(fit))
```